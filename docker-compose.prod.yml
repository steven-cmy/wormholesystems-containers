services:
  app:
    image: wormhole-systems:latest
    build:
      context: .
      dockerfile: dockerfiles/common/frankenPHP/Dockerfile
    environment:
      SERVER_NAME: ":80"
    networks:
      - ws-internal
      - web
    volumes:
      - laravel-storage:/app/storage
      - caddy_data:/data
      - caddy_config:/config
      - ./dockerfiles/production/frankenPHP/php.ini:/usr/local/etc/php/conf.d/custom.ini
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://127.0.0.1:80/"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      mysql:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      - "traefik.http.routers.wormholesystems.service=app"
      # IMPORTANT: Traefik now talks directly to the Caddy server (FrankenPHP) on its default port 80
      - "traefik.http.services.app.loadbalancer.server.port=80"
      - "traefik.http.routers.wormholesystems.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.wormholesystems.entrypoints=websecure"
      - "traefik.http.routers.wormholesystems.tls.certresolver=primary"
      - "traefik.http.middlewares.secure-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.secure-headers.headers.customrequestheaders.X-Forwarded-For="
      - "traefik.http.routers.wormholesystems.middlewares=secure-headers"
  mysql:
    image: mariadb:latest
    hostname: mysql
    networks:
      - ws-internal
    volumes:
      - mysql-data:/var/lib/mysql
      - mysql-logs:/var/log/mysql
    env_file:
      - dockerfiles/mysql/.env
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3
  redis:
    image: redis:latest
    hostname: redis
    networks:
      - ws-internal
    volumes:
      - redis-logs:/var/log/redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
  queue:
    image: wormhole-systems:latest
    tty: true
    networks:
      - ws-internal
    deploy:
      mode: replicated
      replicas: 5
    volumes:
      - laravel-storage:/app/storage
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    restart: unless-stopped
    depends_on:
      app:
        condition: service_healthy
  scheduler:
    image: wormhole-systems:latest
    tty: true
    networks:
      - ws-internal
    volumes:
      - laravel-storage:/app/storage
    command: php artisan schedule:work
    restart: unless-stopped
    depends_on:
      app:
        condition: service_healthy
  reverb:
    image: wormhole-systems:latest
    tty: true
    networks:
      - ws-internal
      - web
    volumes:
      - laravel-storage:/app/storage
    depends_on:
      app:
        condition: service_healthy
    command: php artisan reverb:start --host=${REVERB_HOST:-0.0.0.0} --port=${REVERB_PORT:-8080} --debug
    restart: ${RESTART_POLICY:-always}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      - "traefik.http.routers.wormholesystems-reverb.service=reverb"
      - "traefik.http.routers.wormholesystems-reverb.rule=Host(`${WS_DOMAIN}`)"
      - "traefik.http.routers.wormholesystems-reverb.entrypoints=websecure"
      - "traefik.http.routers.wormholesystems-reverb.tls.certresolver=primary"
      - "traefik.http.services.reverb.loadbalancer.server.port=${REVERB_PORT:-8080}"
      - "traefik.http.services.reverb.loadbalancer.server.scheme=http"
volumes:
  mysql-data:
  laravel-storage:
  caddy_data:
  caddy_config:
  # Log volumes for persistent storage
  mysql-logs:
  redis-logs:


networks:
  ws-internal:
  web:
    external: true
