services:
  wormhole-systems-test:
    image: wormhole-systems-test:latest
    build:
      context: .
      dockerfile: dockerfiles/common/php-fpm/Dockerfile
    networks:
      - test-ws-internal
    volumes:
      - laravel-storage-test:/var/www/html
      - php-logs-test:/var/log/php
      - laravel-logs-test:/var/www/html/storage/logs
      - ./dockerfiles/test/php-fpm/php.ini:/usr/local/etc/php/conf.d/custom.ini
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      mysql:
        condition: service_healthy
  mysql:
    image: mariadb:latest
    hostname: mysql
    networks:
      - test-ws-internal
    volumes:
      - mysql-data-test:/var/lib/mysql
      - mysql-logs-test:/var/log/mysql
    env_file:
      - dockerfiles/mysql/.env
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3
  redis:
    image: redis:latest
    hostname: redis
    networks:
      - test-ws-internal
    volumes:
      - redis-logs-test:/var/log/redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
  server:
    image: nginx:latest
    networks:
      - test-ws-internal
      - web
    volumes:
      - laravel-storage-test:/var/www/html
      - nginx-logs-test:/var/log/nginx
      - ./dockerfiles/test/nginx/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      wormhole-systems-test:
        condition: service_healthy
    restart: ${RESTART_POLICY:-always}
    environment:
      - APP_DOMAIN=${APP_DOMAIN:-localhost}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      - "traefik.http.routers.test-wormholesystems.service=server"      
      - "traefik.http.routers.test-wormholesystems.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.test-wormholesystems.entrypoints=websecure"
      - "traefik.http.routers.test-wormholesystems.tls.certresolver=primary"
      - "traefik.http.services.server.loadbalancer.server.port=80"
      - "traefik.http.middlewares.secure-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.secure-headers.headers.customrequestheaders.X-Forwarded-For="
      - "traefik.http.routers.test-wormholesystems.middlewares=secure-headers"
  queue:
    image: wormhole-systems-test:latest
    tty: true
    networks:
      - test-ws-internal
    volumes:
      - laravel-storage-test:/var/www/html
      - laravel-logs-test:/var/www/html/logs
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    restart: unless-stopped
    depends_on:
      wormhole-systems-test:
        condition: service_healthy
  scheduler:
    image: wormhole-systems-test:latest
    tty: true
    networks:
      - test-ws-internal
    volumes:
      - laravel-storage-test:/var/www/html
      - laravel-logs-test:/var/www/html/logs
    command: php artisan schedule:work
    restart: unless-stopped
    depends_on:
      wormhole-systems-test:
        condition: service_healthy
  reverb:
    image: wormhole-systems-test:latest
    tty: true
    networks:
      - test-ws-internal
      - web
    volumes:
      - laravel-storage-test:/var/www/html
      - laravel-logs-test:/var/www/html/logs
    depends_on:
      wormhole-systems-test:
        condition: service_healthy
    command: php artisan reverb:start --host=${REVERB_HOST:-0.0.0.0} --port=${REVERB_PORT:-8080} --debug
    restart: ${RESTART_POLICY:-always}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      - "traefik.http.routers.test-wormholesystems-reverb.service=reverb"
      - "traefik.http.routers.test-wormholesystems-reverb.rule=Host(`${WS_DOMAIN}`)"
      - "traefik.http.routers.test-wormholesystems-reverb.entrypoints=websecure"
      - "traefik.http.routers.test-wormholesystems-reverb.tls.certresolver=primary"
      - "traefik.http.services.reverb.loadbalancer.server.port=${REVERB_PORT:-8080}"
      - "traefik.http.services.reverb.loadbalancer.server.scheme=http"
volumes:
  mysql-data-test:
  laravel-storage-test:
  # Log volumes for persistent storage
  nginx-logs-test:
  php-logs-test:
  mysql-logs-test:
  redis-logs-test:
  laravel-logs-test:


networks:
  test-ws-internal:
  web:
    external: true
